<!DOCTYPE HTML>
<html>
  <head>
    <title>KotOR</title>
    <link rel="stylesheet" href="../css/game.css" />
  </head>
  <body>
    <div id="renderer-container" class="ui-layout-center"></div>
    <div class="console"><input type="text"></div>
    <script>
      window.fs = require('fs');
      const path = require('path');
      const remote = require('electron').remote;
      const app = remote.app;
      const ConfigManager = require(path.join(app.getAppPath(), 'launcher/ConfigManager.js'));
      const Config = new ConfigManager('settings.json');

      //app_profile is the selected game's profile
      const app_profile = (() => {
        let app_profile = remote.getCurrentWindow().state;
        if(typeof app_profile != 'object' || !app_profile.key){
          alert('Fatal Error: Window Profile Missing');
          window.close();
        }
        return Config.get(['Profiles', app_profile.key]);
      })();

      const Games = {
        KOTOR: 1,
        TSL: 2
      }

      switch(app_profile.launch.args.gameChoice){
        case 2:
          window._Game = Games.TSL;
          window.GameKey = 'TSL';
        break;
        default:
          window._Game = Games.KOTOR;
          window.GameKey = 'KOTOR';
        break;
      }

      console.log(app_profile)
    </script>
    <script type="text/javascript" src="../dist/KotOR.js"></script>
    <script type="module">
      import { get, set } from 'https://unpkg.com/idb-keyval@5.0.2/dist/esm/index.js';

      KotOR.ApplicationProfile.directory = KotOR.GameFileSystem.rootDirectoryPath = app_profile.directory;
      KotOR.ApplicationProfile.ENV = "ELECTRON";
      
      const initializeApp = function(){
        console.log('loading game...')
        KotOR.LoadingScreen.main.SetLogo(app_profile.logo);
        KotOR.LoadingScreen.main.SetBackgroundImage(app_profile.background);
        KotOR.LoadingScreen.main.Show();
        KotOR.GameState.GameKey = window.GameKey;
        KotOR.GameInitializer.Init({
          game: window.GameKey,
          onLoad: () => {
            console.log('loaded')
            KotOR.GameState.OpeningMoviesComplete = true;
            KotOR.GUIListBox.InitTextures();
            KotOR.OdysseyWalkMesh.Init();
            KotOR.GameState.Init();
            KotOR.GameState.audioEngine.musicGain.gain.value = 0;
          }
        });
      };
      
      initializeApp();
    </script>
    <script>

      // if(!app_profile){
      //   alert('Fatal Error: Window Profile Corrupted');
      //   window.close();
      // }

      // function initialize(){

      //   verifyGame({
      //     directory: app_profile.directory,
      //     onVerify: () => {
      //       if(!Config.get('Game.debug.disable_intro_movies')){
      //         VideoPlayer.Load('ObsidianEnt', () => {
      //           VideoPlayer.Load('biologo', () => {
      //             VideoPlayer.Load('leclogo', () => {
      //               VideoPlayer.Load('Legal', () => {
      //                 Game.OpeningMoviesComplete = true;
      //                 if(Game.Ready){
      //                   Game.OnReady();
      //                 }
      //               });
      //             });
      //           });
      //         });
      //       }else{
      //         Game.OpeningMoviesComplete = true;
      //         if(Game.Ready){
      //           Game.OnReady();
      //         }
      //       }
      //       loader.Show();
      //       GameInitializer.Init({
      //         game: Games[GameKey],
      //         onLoad: () => {
      //           loader.SetMessage("Loading Game Menus");
      //           console.log('Game: Init');
      //           GUIListBox.InitTextures();
      //           AuroraWalkMesh.Init();
      //           Game.Init();
      //         }
      //       });
      //     },
      //     onError: async () => {
      //       console.log('Failed to verify the path for', GameKey);
      //       //loader.Dismiss();
            
      //       dialog.showOpenDialog({title: 'Locate Game Directory', properties: ['openDirectory', 'createDirectory']}).then(result => {
      //         console.log(result.canceled);
      //         console.log(result.filePaths);
      //         if(result.filePaths.length && !result.canceled){
      //           Config.set(['Profiles', app_profile.key, 'directory'], result.filePaths[0]);
      //           window.location.reload();
      //         }else{
      //           alert('Can\'t continue without locating the game directory');
      //           window.close();
      //         }

      //       }).catch(err => {
      //         alert(err);
      //         window.close();
      //       });
            
      //     }
      //   });

      // }

      // function verifyGame(args = {}){

      //   args = $.extend({
      //     directory: null,
      //     onVerify: null,
      //     onError: null
      //   }, args);

      //   if(args.directory != null){
      //     try {
      //       fs.accessSync(args.directory, fs.F_OK);
      //       if(typeof args.onVerify == 'function')
      //         args.onVerify();
      //     } catch (e) {
      //       Config.set(['Profiles', app_profile.key, 'directory'], null);
      //       if(typeof args.onError == 'function')
      //         args.onError();
      //     }
      //   }else{
      //     Config.set(['Profiles', app_profile.key, 'directory'], null);
      //     if(typeof args.onError == 'function')
      //         args.onError();
      //   }

      // }

      // initialize();

      // window.addEventListener('keyup', function(e) {
      //   if(e.keyCode == 192){
      //     let $ele = $('.console');
      //     if($ele.hasClass('on')){
      //       $ele.removeClass('on');
      //       $('input', $ele).val('');
      //     }else{
      //       $ele.addClass('on');
      //       $('input', $ele).focus();
      //     }
      //   }
      // });

      // $('.console input').keyup(function(e){
      //   if(e.keyCode == 13) {
      //     let $ele = $('.console');
      //     $ele.removeClass('on');

      //     let console_text = $(this).val().toLowerCase();
      //     processConsoleText(console_text);
      //     $(this).val('');
      //   }
      // });

      // function processConsoleText(text){

      //   text = text.trim();
      //   let args = text.split(' ');

      //   switch(args[0]){
      //     case 'warp':
      //       if(args[1]){
      //         Game.LoadModule(args[1]);
      //       }
      //     break;
      //   }

      // }

    </script>
  </body>
</html>